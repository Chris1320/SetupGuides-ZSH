#!/usr/bin/env bash

name="SetupGuides/ZSH"
version=(0 1 0)
title="${name} v${version[@]:1}.${version[@]:2}.${version[@]:3}"
omz_installation="$HOME/.oh-my-zsh"

echo "$title"
echo

# Check if the script is running as root.
if [[ "$EUID" -eq 0 ]]; then
    echo "This script must not be run as root."
    echo "Run with \`./install\` instead."
    exit 1

fi

# Check if the scsript is running on Termux.
if [[ $PREFIX = *"com.termux"* ]]; then
    sudocmd=""  # No need for sudo on Termux.

else
    sudocmd="sudo"
fi

echo "Installing zsh, wget, and git..."
${sudocmd} apt update && ${sudocmd} apt install --upgrade zsh wget git

echo "Installing Oh-My-ZSH..."
ZSH="$omz_installation" sh -c "$(wget -q -O - https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" || echo "Failed to install Oh-My-ZSH." && exit 2

echo "Cloning Powerlevel10k theme..."
git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${omz_installation}/custom/themes/powerlevel10k || echo "Failed to clone Powerlevel10k theme." && exit 3

echo "Installing zsh-autosuggestions..."
git clone --depth=1 https://github.com/zsh-users/zsh-autosuggestions.git ${omz_installation}/custom/plugins/zsh-autosuggestions || echo "Failed to install zsh-autosuggestions." && exit 4

echo "Installing zsh-syntax-highlighting..."
git clone --depth=1 https://github.com/zsh-users/zsh-syntax-highlighting.git ${omz_installation}/custom/plugins/zsh-syntax-highlighting || echo "Failed to install zsh-syntax-highlighting." && exit 5

echo "Editing \`.zshrc\`..."
sed -i 's/^ZSH_THEME=.*/ZSH_THEME="powerlevel10k\/powerlevel10k"/' "${HOME}/.zshrc"
sed -i 's/^plugins=.*/plugins=(command-not-found gh git python sudo zsh-autosuggestions zsh-syntax-highlighting)/' "${HOME}/.zshrc"
echo 'export LANG=en_US.UTF-8  # Set language environment variable.' >> "${HOME}/.zshrc"
echo 'export LESS="--no-init --quit-if-one-screen -R"  # Causes `less` to just write to stdout if the text can be viewed without scrolling.' >> "${HOME}/.zshrc"
echo 'export GPG_TTY=$TTY  # Fix GPG "gpg failed to sign data" error.' >> "${HOME}/.zshrc"

echo "Changing default shell to zsh..."
chsh -s $(command -v zsh) || chsh -s zsh || echo "Failed to change shell." && exit 6  # Try alternative command if chsh fails.
echo
echo "Please restart your terminal. ZSH should now be your default shell after restart."
exit 0
